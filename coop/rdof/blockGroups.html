<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title></title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/g/filesaver.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.css"
      rel="stylesheet"
    />
    <link
      href="https://unpkg.com/tailwindcss@1.6.2/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      .mapWrapper {
        height: 800px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <style>
      #menu {
        background: white;
        position: absolute;
        z-index: 1;
        top: 1.5em;
        right: 1.5em;
        border-radius: 3px;
        width: 120px;
        border: 1px solid rgba(0, 0, 0, 0.4);
      }

      #menu a {
        font-size: 13px;
        color: lightgray;
        display: block;
        margin: 0;
        padding: 0;
        padding: 10px;
        text-decoration: none;
        border-bottom: 1px solid rgba(0, 0, 0, 0.25);
        text-align: center;
      }

      #menu a:last-child {
        border: none;
      }

      #menu a:hover {
        color: slategray;
      }

      #menu a.active {
        background-color: white;
        color: black;
      }

      #menu a.active:hover {
        color: lightgray;
      }
    </style>

    <div class="">
      <div class="grid grid-cols-12">
        <div class="col-span-8">
          <div class="bg-white overflow-hidden shadow-xs rounded-sm">
            <div class="mapWrapper min-h-screen max-h-screen">
              <div id="map"></div>
              <nav id="menu"></nav>
            </div>
          </div>
        </div>
        <div class="col-span-4 px-8 bg-gray-100" id="content">
          <div class="min-h-screen max-h-screen overflow-auto hidden" id="data">
            <div
              class="p-3 rounded-sm my-8 bg-blue-100 font-semibold text-blue-700 border-blue-600 border-l-4"
            >
              <span class="block mb-4"
                ><span id="blockGroupCount"></span> block groups selected.</span
              ><button
                class="block underline mb-1 text-xs font-semibold"
                onclick="downloadCsv()"
              >
                Download CSV</button
              ><button
                class="block underline mb-1 text-xs font-semibold"
                onclick="highlightAllBlockGroups()"
              >
                Highlight all block groups</button
              ><button
                class="block underline mb-1 text-xs font-semibold"
                onclick="clearAllBlockGroups()"
              >
                Clear all block groups
              </button>
            </div>

            <h1 class="font-semibold text-2xl leading-none">
              10 year reserve price
            </h1>
            <dl class="my-4">
              <dt class="text-sm font-medium text-gray-700 truncate mt-2">
                Green or Purple Block Group Total
              </dt>
              <dd class="text-xl font-semibold text-gray-900" id="amount"></dd>
              <dt class="text-sm font-medium text-gray-700 truncate mt-2">
                Green Block Groups Only
              </dt>
              <dd
                class="text-xl font-semibold text-gray-900"
                id="amount50"
              ></dd>
            </dl>

            <h1 class="font-semibold text-2xl leading-none">FCC locations</h1>
            <dl class="my-4">
              <dt class="text-sm font-medium text-gray-700 truncate mt-2">
                Total
              </dt>
              <dd
                class="text-xl font-semibold text-gray-900"
                id="locations"
              ></dd>
            </dl>

            <h1 class="font-semibold text-2xl leading-none">
              Number of block groups
            </h1>
            <dl class="my-4">
              <dt class="text-sm font-medium text-gray-700 truncate mt-2">
                Green or Purple Block Group Total
              </dt>
              <dd
                class="text-xl font-semibold text-gray-900"
                id="blockGroupsTotal"
              ></dd>
              <dt class="text-sm font-medium text-gray-700 truncate mt-2">
                Green Block Groups Only
              </dt>
              <dd
                class="text-xl font-semibold text-gray-900"
                id="blockGroups50"
              ></dd>
            </dl>

            <h1 class="font-semibold text-2xl leading-none">
              Off system cost estimate
            </h1>
            <h2 class="font-semibold text-xs leading-none mt-2 text-gray-600">
              (FCC locations - Meters in RDOF blocks) *
              <span id="costEstimate"></span> / 24.1987
            </h2>

            <label
              for="estimate"
              class="mt-4 block text-sm font-medium leading-5"
              >Enter your per meter cost estimate</label
            >
            <div class="mt-1 relative flex rounded-md shadow-sm w-16">
              <span
                class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm"
              >
                $ </span
              ><input
                id="estimate"
                class="border border-gray-400 flex-1 block w-16 px-3 py-2 rounded-none rounded-r-md sm:text-sm sm:leading-5"
                name="estimate"
                placeholder="you@example.com"
                value="5000"
                onchange="updateCost()"
              />
            </div>

            <dl class="my-4">
              <dt class="text-sm font-medium text-gray-700 truncate mt-2">
                Cost per year
              </dt>
              <dd
                class="text-xl font-semibold text-gray-900"
                id="offSystemCostEstimate"
              ></dd>
              <dt class="text-sm font-medium text-gray-700 truncate mt-2">
                Potential revenue per year
              </dt>
              <dd
                class="text-xl font-semibold text-gray-900"
                id="totalRevenue"
              ></dd>
            </dl>

            <table>
              <tr>
                <th>% of RDOF funds</th>
                <th>Revenue + % RDOF funds</th>
              </tr>
              <tr>
                <th>100%</th>
                <th id="at100"></th>
              </tr>
              <tr>
                <th>90%</th>
                <th id="at90"></th>
              </tr>
              <tr>
                <th>80%</th>
                <th id="at80"></th>
              </tr>
              <tr>
                <th>70%</th>
                <th id="at70"></th>
              </tr>
              <tr>
                <th>60%</th>
                <th id="at60"></th>
              </tr>
              <tr>
                <th>50%</th>
                <th id="at50"></th>
              </tr>
              <tr>
                <th>40%</th>
                <th id="at40"></th>
              </tr>
              <tr>
                <th>30%</th>
                <th id="at30"></th>
              </tr>
              <tr>
                <th>20%</th>
                <th id="at20"></th>
              </tr>
              <tr>
                <th>10%</th>
                <th id="at10"></th>
              </tr>
              <tr>
                <th>0%</th>
                <th id="at0"></th>
              </tr>
            </table>

            <h1 class="font-semibold text-2xl leading-none">Meter data</h1>
            <dl class="my-4">
              <dt class="text-sm font-medium text-gray-700 truncate mt-2">
                Total
              </dt>
              <dd class="text-xl font-semibold text-gray-900" id="meters"></dd>
              <dt class="text-sm font-medium text-gray-700 truncate mt-2">
                In RDOF blocks
              </dt>
              <dd
                class="text-xl font-semibold text-gray-900"
                id="meters_rdof"
              ></dd>
            </dl>
          </div>
          <div class="min-h-screen max-h-screen overflow-auto" id="intro">
            <p class="text-lg font-semibold mt-8">
              The industry’s only mapping tool that displays the exact total of
              federal funding available for a co-op, with an additional in-depth
              view that calculates eligible dollars at the census block,
              substation and feeder level. It provides a discrete picture of
              each census block, the percentage within a co-op is required to
              serve, how it matches up to the co-op’s existing infrastructure,
              and potential dollars.
            </p>
            <p class="mt-8 text-gray-800">
              This unmatched level of detail gives you the information you need
              to form a financially sound bidding strategy in the upcoming RDOF
              auction. Co-ops who successfully bid in this auction stand to be
              awarded as much as 75% to 100% of their total broadband network
              costs:
            </p>
            <ul class="list-disc list-inside mt-8 text-gray-800">
              <li>
                Understand where it’s most advantageous to bid and where it’s
                not;
              </li>
              <li>Identify potential partnerships with neighboring co-ops;</li>
              <li>
                Leverage the data as a roadmap for the most logical and
                profitable buildout
              </li>
            </ul>
            <p class="my-8 text-gray-800">
              Get started by clicking one or more block groups to view RDOF data
              and meters or
              <button
                class="text-blue-700 underline"
                onclick="highlightAllBlockGroups()"
              >
                highlight all block groups</button
              >.
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="container mx-auto mt-8 border-t pt-8 text-lg">
      <img width="75px" class="inline" src="../../images/logo.png" />
      <span class="text-3xl">conexon</span>
    </div>

    <script>
      // cost estimate
      document.getElementById(
        'costEstimate'
      ).innerHTML = document.getElementById('estimate').value;

      let stateAbbr = '';
      let rusNumber = '';
      let metersAttribute = '';
      let percentAttribute = '';
      let coopCode = '';
      let zoom = 12;
      let center = [];
      let minZoom = 9;
      let maxZoom = 15;

      // colors
      const blockFill = 'orange';
      const blockGroupFill = 'green';
      const blockGroupBorder = 'darkgreen';
      const blockGroup2Fill = 'blue';
      const blockGroup2Border = 'blue';
      const meters = 'gray';
      const blockBorder = 'black';
      const meterColors = [
        'blue',
        //'orange',
        'green',
        'brown',
        'slategray',
        'red',
        'aqua',
      ];

      let blockGroupData;
      let allGeoids = [];
      let blockGroupTotals = {
        locations: 0,
        amount: 0,
        amount50: 0,
        meters: 0,
        meters_no_service: 0,
        meters_underserved: 0,
        meters_fiber: 0,
        meters_rdof: 0,
        meters_cable: 0,
        meters_telco: 0,
      };
      let selectedGeoids = [];
      let dataForCsv = [];

      let selectedSubstations = [];

      const dataContainer = document.getElementById('data');
      const introContainer = document.getElementById('intro');
      const menuContainer = document.getElementById('menu');
      const mapContainer = document.getElementById('map');

      mapboxgl.accessToken =
        'pk.eyJ1IjoiY29uZXhvbi1kZXNpZ24iLCJhIjoiY2pvdzZlb2djMXVhOTN3bmhpYzk3NndoZCJ9.On4IrAd0sgmmgd_sAqg_Gg';
      const map = new mapboxgl.Map({
        container: 'map',
        hash: true,
        style: 'mapbox://styles/conexon-design/cjow6vt3sax7q2rpbj5wm7s84',
      });

      const downloadCsv = () => {
        const blobData = Papa.unparse(dataForCsv, {
          header: true,
        });
        try {
          saveAs(
            new Blob([blobData], {
              type: 'text/csv;charset=utf-16',
            }),
            `${coopCode}-RDOF.csv`
          );
        } catch (e) {
          window.open(
            'data:text/csv;charset=utf-16,' + encodeURIComponent(blobData),
            '_blank',
            ''
          );
        }
      };

      const updateCost = () => {
        let offSystemCostEstimate = 0;
        const enteredEstimate = parseInt(
          document.getElementById('estimate').value
        );

        selectedGeoids.forEach((geoid) => {
          const selectedBlockGroup = blockGroupData.find(
            (blockGroup) => blockGroup.geoid === geoid
          );

          offSystemCostEstimate =
            (selectedBlockGroup.locations - selectedBlockGroup.meters_rdof) *
              enteredEstimate >
            0
              ? offSystemCostEstimate +
                (selectedBlockGroup.locations -
                  selectedBlockGroup.meters_rdof) *
                  enteredEstimate
              : offSystemCostEstimate;
        });

        document.getElementById(
          'offSystemCostEstimate'
        ).innerHTML = offSystemCostEstimate.toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });

        updateData(selectedGeoids);
      };

      const stateCodes = [
        ['AK', '02'],
        ['AL', '01'],
        ['AZ', '04'],
        ['AR', '05'],
        ['CA', '06'],
        ['CO', '08'],
        ['CT', '09'],
        ['DE', '10'],
        ['DC', '11'],
        ['FL', '12'],
        ['GA', '13'],
        ['HI', '15'],
        ['ID', '16'],
        ['IL', '17'],
        ['IN', '18'],
        ['IA', '19'],
        ['KS', '20'],
        ['KY', '21'],
        ['LA', '22'],
        ['ME', '23'],
        ['MD', '24'],
        ['MA', '25'],
        ['MI', '26'],
        ['MN', '27'],
        ['MS', '28'],
        ['MO', '29'],
        ['MT', '30'],
        ['NE', '31'],
        ['NV', '32'],
        ['NH', '33'],
        ['NJ', '34'],
        ['NM', '35'],
        ['NY', '36'],
        ['NC', '37'],
        ['ND', '38'],
        ['OH', '39'],
        ['OK', '40'],
        ['OR', '41'],
        ['PA', '42'],
        ['RI', '44'],
        ['SC', '45'],
        ['SD', '46'],
        ['TN', '47'],
        ['TX', '48'],
        ['UT', '49'],
        ['VT', '50'],
        ['VA', '51'],
        ['WA', '53'],
        ['WV', '54'],
        ['WI', '55'],
        ['WY', '56'],
        ['AS', '60'],
        ['GU', '66'],
        ['MP', '69'],
        ['VI', '78'],
        ['PR', '72'],
      ];

      const updateData = (geoids) => {
        if (geoids.length === 0) {
          document.getElementById('intro').classList.remove('hidden');
          document.getElementById('data').classList.add('hidden');
          document.getElementById('estimate').value = 5000;
          document.getElementById('costEstimate').innerHTML = 5000;
        } else {
          document.getElementById('intro').classList.add('hidden');
          document.getElementById('data').classList.remove('hidden');
          document.getElementById('blockGroupCount').innerHTML = geoids.length;
        }

        let geoidFilters = ['case'];
        geoids.forEach((geoid) => {
          geoidFilters.push(['==', ['get', 'geoid'], geoid], 'red');
        });
        geoidFilters.push(
          ['<', ['to-number', ['get', percentAttribute]], 50],
          blockGroup2Fill,
          blockGroupFill
        );
        map.setPaintProperty('blockGroups', 'fill-color', [...geoidFilters]);
        map.setPaintProperty('blockGroupsLines', 'line-color', [
          ...geoidFilters,
        ]);
        map.setPaintProperty('blockGroupsText', 'text-color', [
          ...geoidFilters,
        ]);

        let locations = 0;
        let amount = 0;
        let amount50 = 0;
        let groups50 = 0;
        let meters = 0;
        let meters_no_service = 0;
        let meters_underserved = 0;
        let meters_fiber = 0;
        let meters_rdof = 0;
        let meters_telco = 0;
        let meters_cable = 0;
        let totalOffSystemCostEstimate = 0;
        let totalRevenue = 0;

        dataForCsv = [];
        dataForCsv.push([
          'ITEM',
          'T+L_WEIGHT',
          'PRICE_POINT_ENTERED',
          'PACKAGE_ID',
          'MIN_SCALE_PCT',
          'reserve_price',
          'state',
          'census_id',
          'locations',
          'member',
        ]);

        geoids.forEach((geoid) => {
          const selectedBlockGroup = blockGroupData.find(
            (blockGroup) => blockGroup.geoid === geoid
          );
          locations += selectedBlockGroup.locations;
          amount += selectedBlockGroup.amount;
          amount50 +=
            selectedBlockGroup.pct >= 50 ? selectedBlockGroup.amount : 0;
          groups50 += selectedBlockGroup.pct >= 50 ? 1 : 0;
          meters += selectedBlockGroup.meters;
          meters_no_service += selectedBlockGroup.meters_no_service;
          meters_underserved += selectedBlockGroup.meters_underserved;
          meters_fiber += selectedBlockGroup.meters_fiber;
          meters_rdof += selectedBlockGroup.meters_rdof;
          meters_telco += selectedBlockGroup.meters_telco;
          meters_cable += selectedBlockGroup.meters_cable;
          totalOffSystemCostEstimate =
            (selectedBlockGroup.locations - selectedBlockGroup.meters_rdof) *
              document.getElementById('estimate').value >
            0
              ? totalOffSystemCostEstimate +
                (selectedBlockGroup.locations -
                  selectedBlockGroup.meters_rdof) *
                  document.getElementById('estimate').value
              : totalOffSystemCostEstimate;
          offSystemCostEstimate =
            (selectedBlockGroup.locations - selectedBlockGroup.meters_rdof) *
              document.getElementById('estimate').value >
            0
              ? (selectedBlockGroup.locations -
                  selectedBlockGroup.meters_rdof) *
                document.getElementById('estimate').value
              : 0;

          // 60 = gross margins
          // .32 = take rate %
          // 12 is monthly
          totalRevenue =
            (selectedBlockGroup.locations - selectedBlockGroup.meters_rdof) *
            60 *
            0.32 *
            12;

          const stateCode = geoid.substring(0, 2);
          let stateAbbreviation = '';
          stateCodes.forEach((stateArray) => {
            if (stateArray[1] === stateCode) {
              stateAbbreviation = stateArray[0];
            }
          });
          const countyFIPS = geoid.substring(2, 5);
          const blockGroupNumber = geoid.substring(6, 12);

          dataForCsv.push([
            `${stateAbbreviation}-${countyFIPS}-${blockGroupNumber}`,
            '0',
            '50',
            '',
            '',
            parseInt(selectedBlockGroup.amount, 10) / 10,
            stateAbbreviation,
            geoid,
            selectedBlockGroup.locations,
            coopCode,
          ]);
        });
        // update the data

        document.getElementById('amount').innerHTML = amount.toLocaleString(
          'en-US',
          {
            style: 'currency',
            currency: 'USD',
          }
        );
        document.getElementById('amount50').innerHTML = amount50.toLocaleString(
          'en-US',
          {
            style: 'currency',
            currency: 'USD',
          }
        );
        document.getElementById('locations').innerHTML = locations;
        document.getElementById('blockGroupsTotal').innerHTML = geoids.length;
        document.getElementById('blockGroups50').innerHTML = groups50;
        document.getElementById('offSystemCostEstimate').innerHTML = (
          totalOffSystemCostEstimate / 24.1987
        ).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
        document.getElementById(
          'totalRevenue'
        ).innerHTML = totalRevenue.toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
        document.getElementById('at100').innerHTML = (
          totalRevenue +
          amount / 10
        ).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
        document.getElementById('at90').innerHTML = (
          totalRevenue +
          (amount * 0.9) / 10
        ).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
        document.getElementById('at80').innerHTML = (
          totalRevenue +
          (amount * 0.8) / 10
        ).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
        document.getElementById('at70').innerHTML = (
          totalRevenue +
          (amount * 0.7) / 10
        ).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
        document.getElementById('at60').innerHTML = (
          totalRevenue +
          (amount * 0.6) / 10
        ).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
        document.getElementById('at50').innerHTML = (
          totalRevenue +
          (amount * 0.5) / 10
        ).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
        document.getElementById('at40').innerHTML = (
          totalRevenue +
          (amount * 0.4) / 10
        ).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
        document.getElementById('at30').innerHTML = (
          totalRevenue +
          (amount * 0.3) / 10
        ).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
        document.getElementById('at20').innerHTML = (
          totalRevenue +
          (amount * 0.2) / 10
        ).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
        document.getElementById('at10').innerHTML = (
          totalRevenue +
          (amount * 0.1) / 10
        ).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
        document.getElementById('at0').innerHTML = totalRevenue.toLocaleString(
          'en-US',
          {
            style: 'currency',
            currency: 'USD',
          }
        );
        document.getElementById('meters').innerHTML = meters;
        document.getElementById('meters_rdof').innerHTML = meters_rdof;
      };

      const highlightAllBlockGroups = () => {
        selectedGeoids = allGeoids;
        updateData(allGeoids);
      };

      const clearAllBlockGroups = () => {
        selectedGeoids = [];
        updateData([]);
      };

      // get the URL params
      var urlParams = new URLSearchParams(window.location.search);

      // if there's no coopCode param
      if (!urlParams.get('coopCode')) {
        // reset things
        dataContainer.innerHTML =
          '<h1 class="text-2xl m-8">Sorry you need to provide a coopCode, e.g. https://conexon.github.io/coop/rdof/index.html?<span class="font-semibold">coopCode=YourCoop</span></h1>';
        menuContainer.remove();
      } else {
        // fetch the list of clients
        fetch(`/coop/data/clients/clients.json`)
          .then((response) => {
            return response.json();
          })
          .then((data) => {
            // find the given client
            const clientData = data.find(
              (client) =>
                client.coopCode.toLowerCase() ===
                urlParams.get('coopCode').toLowerCase()
            );

            // if not found
            if (!clientData) {
              dataContainer.innerHTML = `<h1 class="text-2xl m-8">Sorry we couldn't find <span class="font-semibold">coopCode=${urlParams.get(
                'coopCode'
              )}</span>. Please double check it.</h1>`;
              menuContainer.remove();
            } else {
              stateAbbr = clientData.stateAbbr;
              rusNumber = clientData.rusNumber;
              metersAttribute = `${rusNumber}_m`;
              percentAttribute = `${rusNumber}_pct`;
              coopCode = clientData.coopCode;
              zoom = clientData.zoom;
              center = clientData.center; // leave as an array  9//
              minZoom = clientData.minZoom || 9;
              maxZoom = clientData.maxZoom || 15;

              map.setZoom(zoom);
              map.setMinZoom(minZoom);
              map.setMaxZoom(maxZoom);
              map.setCenter(center);
              map.setBearing(0);
              map.setPitch(0);

              // tilesets
              const blockGroupsUrl = `mapbox://conexon-design.rdof_bg_${stateAbbr}`;
              const blockGroupsSourceLayer = `rdof_bg_${stateAbbr}`;

              const blocksUrl = `mapbox://conexon-design.rdof_block_${stateAbbr}`;
              const blocksSourceLayer = `rdof_block_${stateAbbr}`;

              const metersUrl = `mapbox://conexon-design.rdof_meters_${stateAbbr}`;
              const metersSourceLayer = `rdof_meters_${stateAbbr}`;

              // initial load, first layers
              map.on('load', function () {
                // block groups fill
                map.addLayer({
                  id: 'blockGroups',
                  type: 'fill',
                  source: {
                    type: 'vector',
                    url: blockGroupsUrl,
                  },
                  'source-layer': blockGroupsSourceLayer,
                  filter: ['>', metersAttribute, 0],
                  paint: {
                    'fill-color': [
                      'case',
                      ['<', ['to-number', ['get', percentAttribute]], 50],
                      blockGroup2Fill,
                      blockGroupFill,
                    ],
                    'fill-opacity': 0.25,
                  },
                  layout: {
                    visibility: 'visible',
                  },
                });
                map.on('click', 'blockGroups', (event) => {
                  console.log(event.features[0].properties);
                });

                // block groups line
                map.addLayer({
                  id: 'blockGroupsLines',
                  type: 'line',
                  source: {
                    type: 'vector',
                    url: blockGroupsUrl,
                  },
                  'source-layer': blockGroupsSourceLayer,
                  filter: ['>', metersAttribute, 0],
                  paint: {
                    'line-color': [
                      'case',
                      ['<', ['to-number', ['get', percentAttribute]], 50],
                      blockGroup2Fill,
                      blockGroupFill,
                    ],
                    'line-width': 3,
                  },
                  layout: {
                    visibility: 'visible',
                  },
                });

                // blocks layer
                map.addLayer({
                  id: 'blocks',
                  type: 'fill',
                  source: {
                    type: 'vector',
                    url: blocksUrl,
                  },
                  'source-layer': blocksSourceLayer,
                  filter: ['>=', metersAttribute, 0],
                  paint: {
                    'fill-color': blockFill,
                    'fill-opacity': [
                      'case',
                      ['==', ['to-number', ['get', metersAttribute]], 0],
                      0.5,
                      0.9,
                    ],
                    'fill-outline-color': blockBorder,
                  },
                  layout: {
                    visibility: 'visible',
                  },
                });
                map.on('click', 'blocks', (event) => {
                  console.log(event.features[0].properties);
                });

                // blocks text layer
                map.addLayer({
                  id: 'blocksText',
                  type: 'symbol',
                  source: {
                    type: 'vector',
                    url: blocksUrl,
                  },
                  'source-layer': blocksSourceLayer,
                  filter: ['>', metersAttribute, 0],
                  layout: {
                    'text-field': ['get', 'geoid10'],
                    'symbol-placement': 'point',
                    'text-allow-overlap': true,
                    'text-justify': 'center',
                    'text-padding': 4,
                    'text-rotation-alignment': 'viewport',
                    'text-size': {
                      base: 0,
                      stops: [
                        [10, 0],
                        [12, 4],
                        [14, 8],
                        [15, 12],
                      ],
                    },
                    visibility: 'visible',
                  },
                });

                // meters layer
                map.addLayer({
                  id: 'meters',
                  type: 'circle',
                  source: {
                    type: 'vector',
                    url: metersUrl,
                  },
                  'source-layer': metersSourceLayer,
                  filter: ['==', 'coop_code', coopCode],
                  paint: {
                    'circle-radius': {
                      base: 2,
                      stops: [
                        [12, 2],
                        [13, 3],
                        [14, 4],
                        [15, 5],
                        [16, 6],
                      ],
                    },
                    'circle-color': meters,
                  },
                  layout: {
                    visibility: 'none',
                  },
                });

                if (coopCode.toLowerCase() === 'osagevly') {
                  map.addLayer({
                    id: 'span',
                    type: 'line',
                    source: {
                      type: 'vector',
                      url: 'mapbox://conexon-design.1twxmcyp',
                    },
                    'source-layer': 'electric_span-bs7qf0',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                  });
                }

                if (coopCode.toLowerCase() === 'sacosage') {
                  map.addLayer({
                    id: 'span',
                    type: 'line',
                    source: {
                      type: 'vector',
                      url: 'mapbox://conexon-design.2eazu3om',
                    },
                    'source-layer': 'electric_span_2-bxelav',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                  });
                }

                map.on('click', 'meters', (event) => {
                  console.log(event.features[0].properties);
                });
              });

              // load the block groups
              map.once('idle', () => {
                // add the text, the $ amounts
                fetch(`/coop/data/rdof_bg_pnt_${stateAbbr}.geojson`)
                  .then((response) => {
                    return response.json();
                  })
                  .then((data) => {
                    map.addSource('blockGroupsText', {
                      type: 'geojson',
                      data: data,
                    });

                    map.addLayer({
                      id: 'blockGroupsText',
                      type: 'symbol',
                      source: 'blockGroupsText',
                      filter: ['>', metersAttribute, 0],
                      paint: {
                        'text-color': [
                          'case',
                          ['<', ['to-number', ['get', percentAttribute]], 50],
                          blockGroup2Fill,
                          blockGroupBorder,
                        ],
                      },
                      layout: {
                        'text-field': [
                          'number-format',
                          ['*', ['get', 'fcc_amt'], 10],
                          { currency: 'USD' },
                        ],
                        'symbol-placement': 'point',
                        'text-allow-overlap': true,
                        'text-justify': 'center',
                        'text-padding': 4,
                        'text-rotation-alignment': 'viewport',
                        'text-font': [
                          'literal',
                          ['DIN Offc Pro Bold', 'Arial Unicode MS Regular'],
                        ],
                        'text-size': {
                          base: 0,
                          stops: [
                            [10, 12],
                            [12, 14],
                            [14, 20],
                            [15, 22],
                            [16, 28],
                          ],
                        },
                        visibility: 'visible',
                      },
                    });
                  });

                const lowerCoopCode = coopCode.toLowerCase();
                fetch(`/coop/data/clients/${lowerCoopCode}_geoid.json`)
                  .then((response) => {
                    return response.json();
                  })
                  .then((data) => {
                    blockGroupData = data;
                    // build the list of block groups based on this data
                    data.forEach((blockGroup) => {
                      blockGroupTotals.locations += blockGroup.locations;
                      blockGroupTotals.amount += blockGroup.amount;
                      blockGroupTotals.amount50 +=
                        blockGroup.pct >= 50 ? blockGroup.amount : 0;
                      blockGroupTotals.meters += blockGroup.meters;
                      blockGroupTotals.meters_no_service +=
                        blockGroup.meters_no_service;
                      blockGroupTotals.meters_underserved +=
                        blockGroup.meters_underserved;
                      blockGroupTotals.meters_fiber += blockGroup.meters_fiber;
                      blockGroupTotals.meters_rdof += blockGroup.meters_rdof;
                      blockGroupTotals.meters_telco += blockGroup.meters_telco;
                      blockGroupTotals.meters_cable += blockGroup.meters_cable;

                      allGeoids.push(blockGroup.geoid);
                    });
                  });

                map.on('click', 'blockGroups', (event) => {
                  if (
                    selectedGeoids.includes(event.features[0].properties.geoid)
                  ) {
                    const filteredGeoids = selectedGeoids.filter((geoid) => {
                      return geoid !== event.features[0].properties.geoid;
                    });
                    selectedGeoids = filteredGeoids;
                  } else {
                    selectedGeoids.push(event.features[0].properties.geoid);
                  }

                  updateData(selectedGeoids);
                  updateCost(selectedGeoids);
                });

                // substations
                fetch(`/coop/data/clients/${lowerCoopCode}_sub.geojson`)
                  .then((response) => {
                    return response.json();
                  })
                  .then((data) => {
                    allSubstations = data;

                    map.addSource('substations', {
                      type: 'geojson',
                      data: data,
                    });

                    map.addLayer({
                      id: 'substations',
                      type: 'symbol',
                      source: 'substations',
                      layout: {
                        'icon-image': 'black-square-15',
                        'icon-size': {
                          base: 0.5,
                          stops: [
                            [12, 0.75],
                            [13, 1.25],
                            [14, 1.75],
                            [15, 2.25],
                            [16, 3.75],
                          ],
                        },
                        'icon-allow-overlap': true,
                        'text-allow-overlap': true,
                        'text-field': '{subname}',
                        'text-offset': [0, -1],
                        visibility: 'visible',
                      },
                    });

                    map.on('click', 'substations', (event) => {
                      console.log(event.features[0].properties);
                      if (
                        selectedSubstations.includes(
                          event.features[0].properties.cn_substat
                        )
                      ) {
                        const filteredSubstations = selectedSubstations.filter(
                          (cn_substat) => {
                            return (
                              cn_substat !==
                              event.features[0].properties.cn_substat
                            );
                          }
                        );
                        selectedSubstations = filteredSubstations;
                      } else {
                        selectedSubstations.push(
                          event.features[0].properties.cn_substat
                        );
                      }

                      if (selectedSubstations.length > 0) {
                        let meterFilters = [
                          'all',
                          ['==', 'coop_code', coopCode],
                          ['any'],
                        ];
                        selectedSubstations.forEach((substation) => {
                          meterFilters[2].push([
                            '==',
                            'cn_substat',
                            substation,
                          ]);
                        });
                        map.setFilter('meters', meterFilters);
                        map.setLayoutProperty(
                          'meters',
                          'visibility',
                          'visible'
                        );
                      } else {
                        map.setLayoutProperty('meters', 'visibility', 'none');
                      }
                    });
                  });
              });
              // end we have a good client
            }
            // end we have a coopCode param

            // toggle set up
            const toggleableLayerIds = [
              { name: 'Block groups', id: 'blockGroups' },
              { name: 'Blocks', id: 'blocks' },
            ];

            for (let i = 0; i < toggleableLayerIds.length; i++) {
              const id = toggleableLayerIds[i].id;
              const name = toggleableLayerIds[i].name;

              let link = document.createElement('a');
              link.href = '#';
              link.className = 'active';
              link.textContent = name;
              link.id = id;
              link.onclick = function (e) {
                const clickedLayer = this.id;
                e.preventDefault();
                e.stopPropagation();

                const visibility = map.getLayoutProperty(
                  clickedLayer,
                  'visibility'
                );

                if (visibility === 'visible') {
                  this.className = '';
                  map.setLayoutProperty(clickedLayer, 'visibility', 'none');

                  map.setLayoutProperty(
                    `${clickedLayer}Text`,
                    'visibility',
                    'none'
                  );

                  if (clickedLayer === 'blockGroups') {
                    map.setLayoutProperty(
                      `${clickedLayer}Lines`,
                      'visibility',
                      'none'
                    );
                  }
                } else {
                  this.className = 'active';
                  map.setLayoutProperty(clickedLayer, 'visibility', 'visible');

                  map.setLayoutProperty(
                    `${clickedLayer}Text`,
                    'visibility',
                    'visible'
                  );

                  if (clickedLayer === 'blockGroups') {
                    map.setLayoutProperty(
                      `${clickedLayer}Lines`,
                      'visibility',
                      'visible'
                    );
                  }
                }
              };

              const layers = document.getElementById('menu');
              layers.appendChild(link);
            }
          });
      }
    </script>
  </body>
</html>
